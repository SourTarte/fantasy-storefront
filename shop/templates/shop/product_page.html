{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block extraheaders %}
<link href="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-star-rating@4.0.7/css/star-rating.css" media="all" rel="stylesheet" type="text/css" />
<link href="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-star-rating@4.0.7/themes/krajee-svg/theme.css" media="all" rel="stylesheet" type="text/css" />
{% endblock extraheaders %}

{% block content %}
<div class="container">
  <div class="row mb-1">
    <div class="col-sm-7 ">
      <!-- Product image: show placeholder if missing -->
      {% if "placeholder" in product.main_image.url %}
      <img src="{% static 'images/placeholder.webp' %}" class="scale product-page-image" alt="placeholder">
      {% else %}
      <img src="{{ product.main_image.url }}" class="img-fluid mt-3 rounded-3" alt="{{ product.product_name }}" fetchpriority="high">
      {% endif %}
    </div>
    <div class="col mt-3">
      <div class="col py-1 mb-3">
        <h1>{{ product.product_name }}</h1>
        <p class="text-primary">{{ product.price }} Gold</p>
        <!-- Add to Cart button: requires login -->
        {% if user.is_authenticated %}
        <div class="row gy-2 gy-4-xl row-cols-1 row-cols-md-2 row-cols-xl-3">
            <div class="col">
                <a class="btn btn-primary w-100" role="button" aria-current="page" href="{% url 'add_to_cart' product.id %}">Add to Cart</a>
            </div>
            <div class="col">
                <button class="btn btn-outline-secondary w-100 btn-add-wishlist" data-url="{% url 'add_to_wishlist' product.id %}" type="button">Add to Wishlist</button>
                <!-- <a class="btn btn-outline-secondary w-100" role="button" aria-current="page" href="{% url 'view_wishlist' %}">Add to Wishlist</a> -->
            </div>
        </div>
        {% else %}
        <div class="row gy-2 gy-4-xl row-cols-1 row-cols-md-2 row-cols-xl-3">
            <div class="col">
                <a class="btn btn-primary w-100" role="button" aria-current="page" href="{% url 'account_login' %}">Add to Cart</a>
            </div>
            <div class="col">
                <a class="btn btn-outline-secondary w-100" role="button" aria-current="page" href="{% url 'account_login' %}">Add to Wishlist</a>
            </div>
        </div>
        {% endif %}
      </div>
      <div>
        <h4 class="">{{ product.subtitle }}</h4>
        <p>{{ product.description | safe }}</p>
      </div>
    </div>
  </div>
  <!-- Reviews Section -->
  <div class="container">
    <div class="row gx-1">
      <div class="col-md-8 card mb-4 mt-3 ">
        <div class="container" id="reviews-container">
          <h3 class="mt-3">Reviews:</h3>
          <!-- Loop through each review in reviews -->
          {% for review in reviews %}
          <div class="py-2 px-4 comments rounded">
            <hr>
            <h5>{{ review.title }}</h5>
            <p class="font-weight-bold mb-1">
              {{ review.username }}
              <span class="font-weight-normal">
                {{ review.created_on }}
              </span>
            </p>
            <!-- Display review score as read-only star rating -->
            <input id="review-{{review.id}}" name="review-{{review.id}}" class="rating-loading display-review-score" value="{{ review.review_score }}" data-min="0" data-max="5" data-step="1" data-readonly="true">
            <div id="comment{{ review.id }}" class="review-body">
              {{ review.content | linebreaks }}
            </div>
            <!-- Show delete button if user is review author -->
            {% if user.is_authenticated and review.username == user %}
            <button class="btn btn-delete" data-review_id="{{ review.id }}">Delete</button>
            {% endif %}
          </div>
          {% empty %}
          <!-- Message if no reviews exist -->
          <div class="py-2 px-4">
            <h3>No one has reviewed this item.</h3>
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="col-md-4 card mb-4 mt-3 ">
        <div class="card-body">
          {% if user.is_authenticated %}
          <h3>Leave a review:</h3>
          <form id="reviewForm" method="post" style="margin-top: 1.3em;">
            {{ review_form | crispy }}
            <!-- Star Rating Input -->
            <label for="rating-input" class="control-label">Rate This Item*</label>
            <input id="rating-input" name="rating-input" required class="rating-loading" value="0" data-min="0" data-max="5" data-step="1">
            <!-- Submission Button -->
            <button id="submitButton" type="submit" class="btn btn-signup btn-lg">Submit</button>
            {% csrf_token %}
          </form>
          {% else %}
          <p>Log in to leave a review</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Delete confirmation modal for reviews -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete review?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete your review? This action cannot be undone.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a id="deleteConfirm" href="#" class="btn btn-danger">Delete</a>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block extras %}
<script src="{% static 'js/reviews.js' %}"></script>
<script src="{% static 'js/wishlist.js' %}"></script>
<!-- jQuery and Star Rating plugin scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-star-rating@4.1.2/js/star-rating.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-star-rating@4.1.2/themes/krajee-svg/theme.js"></script>
<!-- Optional: Star rating plugin locale (replace LANG.js as needed) -->
<script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-star-rating@4.1.2/js/locales/LANG.js"></script>
<script>
  // Hide the review score field on load
  addEventListener("DOMContentLoaded", (event) => {
    document.getElementById("div_id_review_score").hidden = true;
  });

  // Star rating plugin configuration and initialization
  let pluginOption = {
    showClear: false,
    showCaption: false
  }

  // Initialize star ratings for all displayed reviews
  let reviews = document.getElementById("reviews-container").querySelectorAll(".display-review-score");
  reviews.forEach((review) => {
    $(".display-review-score").rating(pluginOption);
  });

  // Initialize the user review rating input
  $("#rating-input").rating(pluginOption);

  // Update hidden review score field on rating change
  $('#rating-input').on('rating:change', function(event, value, caption) {
    let reviewInputBox = document.getElementById("id_review_score");
    reviewInputBox.value = value
  });
</script>
{% endblock extras %}

{% block copyright %}
Additional Copyright <br>
{% endblock copyright %}